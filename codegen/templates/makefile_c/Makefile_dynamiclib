.PHONY : all prepfolders clean compile link

# PLUMBING
COMPILER=gcc
LINKER=$(COMPILER)

# PROJECT SETUP
# To link to this library, pass [-Wl,-rpath,"."] to your linker (during the linking step, particularly), plus -lthe-final-so-name (i.e. $SONAME in this particular Makefile - see below/further)
# This will tell the application executable to search its own current path (".") for the library's soname. You could also pass "../../../dep/linux/my_library" for example.
OUTNAME=newproject
SO_SUFFIX=-dev.1
SRC=main.c subfolder/second.c
BASE=../../..
BASE_DEP=$(BASE)/dep
CFLAGS=
INCLUDES=
LDFLAGS=
DEPS=
POSTBUILD=

# AUTOCONF PREP
BASE_SRC=$(BASE)/src
BASE_TMP=$(BASE)/tmp
BASE_OUT=$(BASE)/out

# DEFAULTS
PLAT=linux
MODE=release

# MODE
ifeq ($(MODE),)
	# to use, do 'make MODE=debug'
	MODE=debug
endif

# PLAT FLAGS
UNAME_S := $(shell uname -s)

# LINUX
ifeq ($(UNAME_S),Linux)
	PLAT=linux
	CFLAGS+=-std=c18 -m64 -finput-charset=utf-8 -fexec-charset=utf-8
endif

# MACOSX
ifeq ($(UNAME_S),Darwin)
	PLAT=macosx
	CFLAGS+=-std=c18
endif

# DEBUG
ifeq ($(MODE),debug)
	CFLAGS+=-g -Wall -Wextra -Werror -pedantic -fPIC -fsanitize=address -D_GLIBCXX_DEBUG
	LDFLAGS+=-lasan
endif

# RELEASE
ifeq ($(MODE),release)
	CFLAGS+=-O2 -Wall -Wextra -Werror -pedantic -fPIC -DNDEBUG
	POSTBUILD=strip $(OUTNAME_FULL)
endif

# AUTOCONF COMPLETE
TMP_FULL=$(BASE_TMP)/$(PLAT)/$(MODE)
OUT_FULL=$(BASE_OUT)/$(PLAT)/$(MODE)
ALL_OBJS=$(foreach src,$(SRC),$(TMP_FULL)/$(if $(filter-out ./,$(dir $(src))),$(subst /,_,$(dir $(src))),)$(notdir $(src:.c=.o)))
OUTNAME_FULL=$(OUT_FULL)/lib$(OUTNAME).so
SONAME=lib$(OUTNAME)$(SO_SUFFIX).so
INCLUDES+=-I$(BASE_SRC)

# TARGET: ALL
all: prepfolders compile link

# TARGET: PREPFOLDERS
prepfolders:
	@mkdir -p $(TMP_FULL)
	@mkdir -p $(OUT_FULL)

# TARGET: COMPILE
compile:
	$(foreach src,$(SRC),$(COMPILER) $(INCLUDES) $(CFLAGS) -c $(BASE_SRC)/$(src) -o $(TMP_FULL)/$(if $(filter-out ./,$(dir $(src))),$(subst /,_,$(dir $(src))),)$(notdir $(src:.c=.o));)

# TARGET: LINK
link:
	$(LINKER) -o $(OUTNAME_FULL) -shared $(ALL_OBJS) -Wl,-soname,$(SONAME) $(LDFLAGS) $(DEPS)
	$(POSTBUILD)

# TARGET: CLEAN
clean:
	$(foreach objs,$(ALL_OBJS),rm $(objs);)
	rm $(OUTNAME_FULL)
